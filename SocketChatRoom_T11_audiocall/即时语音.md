即时语音与即时视频是同样的技术。

直播还涉及CDN,数据暂存，数据分发技术。



#### RTMP

基于TCP，是一个协议族，包括rtmp基本协议以及RTMPT/RTMPS/RTMPE等多种变种。



群聊技术：

* 转发：数据到达服务器，再由服务器转发给客户端。
* 桥接：客户端与客户端通过服务器建立私有管道。数据在管道消费传输，不上升到业务层。服务器起到代理桥接的作用。



Packet(inputstream) ----------------------write----------------------->  IoArgs

inputStream ----------------------------buffer/loop------------------->Frame



Frame------------>IoArgs



SendPacket ------>Frame....Frame ------------------->IoArgs

ReceivePacket <---------------Frame...Frame <-------IoArgs

数据传输路径



语音包 DirectPacket 大小不固定,同时包含了inputStream、outputStream



#### 服务器桥接改造

**环形缓冲区/圆形缓冲区**：

是一个固定尺寸，数据头尾相结合的数据结构，适合缓存数据流。

当一个元素被删除后，其余元素不需要移动位置，并满足先进先出的规则。

发送数据和接收数据的速度不一定相同，所以需要一个缓冲区，



用一个环形链表和头尾指针表示，头指针表示读的位置，尾指针表示写的位置，当头尾指针相遇时，表示缓冲区为空，没有数据。



改造：

1. 如何识别桥接命令
2. 如何建立“管道”->建立ROOM房间，将两个客户端放入一个房间
3. 房间建立，销毁，连接复用



##### 语音数据编码

语音编码技术：

* Gxx系列：G711,G722,G723.1
* AMRNB/WB, Speex, ILBC/ISAC
* Opus/EVS 开源
* Oboe谷歌高性能-自动延迟调整

Opus的优势：

* 采样率从8到48kHz，比特率从6kb/s到510kb/s
* 对固定码率CBR和可变码率VBR都支持
* 支持语音和音乐，支持单声道和立体声
* 支持多通道（最多255通道）









